{% load static %}
{% load cache %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Title -->
    <title>Test Task</title>

    <!-- Style CSS -->
    <link rel="stylesheet" href="{% static 'style.css' %}">
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/classy-nav.css' %}">
    <link rel="stylesheet" href="{% static 'css/animate.css' %}">
    <link rel="stylesheet" href="{% static 'css/owl.carousel.css' %}">
    <link rel="stylesheet" href="{% static 'css/font-awesome.min.css' %}">


</head>
<body>
<div class="single-blog-wrapper section-padding-0-100">
    <div class="container">
        <div class="row">
            <!-- ##### Post Content Area ##### -->
            <div class="col-12 col-lg-9">
                <!-- Comment Area Start -->

                <div class="comment_area clearfix mt-70">
                    <div class='col-15 col-lg-10 m-md-5'>
                        <a href="?sort=author&order={% if current_sort == 'username' and current_order == 'asc' %}desc{% else %}asc{% endif %}">
                            User Name
                            {% if current_sort == 'username' %}
                            {% if current_order == 'asc' %}▲{% else %}▼{% endif %}
                            {% endif %}
                        </a>
                        <a href="?sort=email&order={% if current_sort == 'email' and current_order == 'asc' %}desc{% else %}asc{% endif %}">
                            E-mail
                            {% if current_sort == 'email' %}
                            {% if current_order == 'asc' %}▲{% else %}▼{% endif %}
                            {% endif %}
                        </a>
                        <a href="?sort=created&order={% if current_sort == 'created' and current_order == 'asc' %}desc{% else %}asc{% endif %}">
                            Date Added
                            {% if current_sort == 'created' %}
                            {% if current_order == 'asc' %}▲{% else %}▼{% endif %}
                            {% endif %}
                        </a>
                    </div>
                    <h5 class="title">Comments ({{comments.count}})</h5>
                    {% include 'includes/messages.html' %}
                    <ul class="comments-list">
                        {% cache 10000 "cache_key" %}
                        {% for comment in comments %}
                        {% include "includes/comment_item.html" with comment=comment %}
                        {% endfor %}
                        {% endcache %}
                        <div id="preview-area"
                             style="display: none; margin-top: 20px; border: 1px solid #ddd; padding: 10px;">
                            <h3>Preview</h3>
                            <p id="preview-username"></p>
                            <p id="preview-email"></p>
                            <p id="preview-content"></p>
                        </div>
                    </ul>
                    <div class="pagination text-center">
                        <span class="step-links">
                            {% if comments.has_previous %}
                                <a href="?page=1">&laquo; first</a>
                                <a href="?page={{ comments.previous_page_number }}">previous</a>
                            {% endif %}
                            {% if comments.number %}
                            <span class="current">
                                Page {{ comments.number }} of {{ comments.paginator.num_pages }}.
                            </span>
                            {%endif%}

                            {% if comments.has_next %}
                                <a href="?page={{ comments.next_page_number }}">next</a>
                                <a href="?page={{ comments.paginator.num_pages }}">last &raquo;</a>
                            {% endif %}
                        </span>
                    </div>
                </div>

                <div class="post-a-comment-area mt-70">
                    <h5>Leave a comment</h5>
                    <form id="comment-form" action="{% url 'index' %}" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-12 col-md-6">
                                <div class="group">
                                    {{ form.username }}
                                    <span class="highlight"></span>
                                    <span class="bar"></span>
                                </div>
                            </div>
                            <div class="col-12 col-md-6">
                                <div class="group">
                                    {{ form.email }}
                                    <span class="highlight"></span>
                                    <span class="bar"></span>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="group">
                                    {{ form.text }}
                                    <span class="highlight"></span>
                                    <span class="bar"></span>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="group">
                                    {{ form.file }}
                                    <span class="highlight"></span>
                                    <span class="bar"></span>
                                </div>
                            </div>
                            <div class="col-12 col-md-2">
                                <div class="group">
                                    {{form.captcha}}
                                    <span class="highlight"></span>
                                    <span class="bar"></span>
                                </div>
                            </div>
                            <div class="col-12">
                                <button type="button" id="preview-button" class="btn original-btn">Preview</button>
                                <button type="submit" class="btn original-btn">Reply</button>
                            </div>
                        </div>
                    </form>
                    <!-- Reply Form -->
                    <form id="reply-form" action="{% url 'index' %}" method="post" style="display: none;"
                          enctype="multipart/form-data">
                        {% csrf_token %}
                        <input type="hidden" name="parent" id="parent-id" value="">
                        <div class="row">
                            <div class="col-12 col-md-6">
                                <div class="group">
                                    {{ form.username }}
                                    <span class="highlight"></span>
                                    <span class="bar"></span>
                                </div>
                            </div>
                            <div class="col-12 col-md-6">
                                <div class="group">
                                    {{ form.email }}
                                    <span class="highlight"></span>
                                    <span class="bar"></span>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="group">
                                    {{ form.text }}
                                    <span class="highlight"></span>
                                    <span class="bar"></span>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="group">
                                    {{ form.file }}
                                    <span class="highlight"></span>
                                    <span class="bar"></span>
                                </div>
                            </div>
                            {{ form.captcha }}
                            <div class="col-12">
                                <button type="submit" class="btn original-btn">Reply</button>
                            </div>
                        </div>
                    </form>
                    <div id="file-preview" style="display: none;">
                        <img id="image-preview" src="" alt="Preview"
                             style="max-width: 320px; max-height: 240px; display: none;">
                        <p id="text-preview" style="display: none;"></p>
                    </div>


                </div>
            </div>
        </div>
    </div>
</div>

<!-- jQuery (Necessary for All JavaScript Plugins) -->
<script src="{%static 'js/jquery/jquery-2.2.4.min.js'%}"></script>
<!-- Popper js -->
<script src="{%static 'js/popper.min.js'%}"></script>
<!-- Bootstrap js -->
<script src="{%static 'js/bootstrap.min.js'%}"></script>
<!-- Plugins js -->
<script src="{%static 'js/plugins.js'%}"></script>
<!-- Active js -->
<script src="{%static 'js/active.js'%}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const replyLinks = document.querySelectorAll('.comment-reply');
        const replyForm = document.getElementById('reply-form');
        const parentInput = document.getElementById('parent-id');
        let currentParentComment = null; // Хранит текущий комментарий, под которым отображается форма

        replyLinks.forEach(link => {
            link.addEventListener('click', function (event) {
                event.preventDefault();

                // Получаем ID комментария из атрибута data-comment-id
                const commentId = this.getAttribute('data-comment-id');
                const parentComment = this.closest('.comment-meta');

                // Проверяем, отображена ли форма под этим комментарием
                if (currentParentComment === parentComment) {
                    // Если да, скрываем форму и очищаем значение
                    replyForm.style.display = 'none';
                    parentInput.value = '';
                    currentParentComment = null;
                } else {
                    // Если нет, отображаем форму под текущим комментарием
                    parentInput.value = commentId;
                    parentComment.appendChild(replyForm);
                    replyForm.style.display = 'block';
                    currentParentComment = parentComment;
                }
            });
        });
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const fileInput = document.getElementById('file-upload');
        const filePreview = document.getElementById('file-preview');
        const imagePreview = document.getElementById('image-preview');
        const textPreview = document.getElementById('text-preview');

        fileInput.addEventListener('change', function () {
            const file = this.files[0];

            // Скрыть предыдущий предпросмотр
            filePreview.style.display = 'none';
            imagePreview.style.display = 'none';
            textPreview.style.display = 'none';

            if (!file) return;

            // Проверка размера файла
            if (file.size > 102400) { // 100 KB
                alert('File size must be less than 100 KB.');
                this.value = ''; // Сбрасываем файл
                return;
            }

            const fileType = file.type;

            // Обработка изображения
            if (fileType.startsWith('image/')) {
                const img = new Image();
                const reader = new FileReader();

                reader.onload = function (e) {
                    img.src = e.target.result;

                    img.onload = function () {
                        // Проверяем размеры изображения
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        let width = img.width;
                        let height = img.height;

                        if (width > 320 || height > 240) {
                            const ratio = Math.min(320 / width, 240 / height);
                            width = Math.round(width * ratio);
                            height = Math.round(height * ratio);
                        }

                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);

                        // Показываем уменьшенное изображение
                        imagePreview.src = canvas.toDataURL(fileType);
                        imagePreview.style.display = 'block';
                        filePreview.style.display = 'block';
                    };
                };

                reader.readAsDataURL(file);

                // Обработка текстового файла
            } else if (fileType === 'text/plain') {
                const reader = new FileReader();

                reader.onload = function (e) {
                    textPreview.textContent = e.target.result;
                    textPreview.style.display = 'block';
                    filePreview.style.display = 'block';
                };

                reader.readAsText(file);
            } else {
                alert('Invalid file type. Only JPG, PNG, GIF, and TXT files are allowed.');
                this.value = ''; // Сбрасываем файл
            }
        });
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const previewButton = document.getElementById('preview-button');
        const previewArea = document.getElementById('preview-area');
        const previewUsername = document.getElementById('preview-username');
        const previewEmail = document.getElementById('preview-email');
        const previewContent = document.getElementById('preview-content');

        previewButton.addEventListener('click', function () {
            const formData = new FormData(document.getElementById('comment-form'));

            // Отправка данных на сервер через AJAX
            fetch("{% url 'preview_message' %}", {
                method: "POST",
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {

                    previewUsername.textContent = `Username: ${data.username}`;
                    previewEmail.textContent = `Email: ${data.email}`;
                    previewContent.innerHTML = `Message: ${data.text}`;
                    previewArea.style.display = 'block';
                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                });
        });
    });
</script>


</body>

</html>